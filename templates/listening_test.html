{% extends 'base.html' %}

{% block title %}
{{ test.title }} - Listening Test
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">

    <!-- Header Bar (Sticky) -->
    <div
        class="bg-white shadow rounded-lg p-4 mb-4 flex flex-col sm:flex-row justify-between items-center sticky top-[65px] z-40">
        <!-- Adjust top value if nav height changes -->
        <h2 class="text-lg sm:text-xl font-semibold mb-2 sm:mb-0">{{ test.title }}</h2>
        <div class="flex items-center space-x-2 sm:space-x-4">
            <div class="text-base sm:text-lg font-medium text-red-600">Timer: <span id="listening-timer">40:00</span>
            </div>
            <!-- Link back to the category selection page -->
            <a href="{{ url_for('test.choose_test', category='Listening') }}"
                class="bg-gray-200 text-gray-700 px-3 py-1 sm:px-4 sm:py-2 rounded-lg text-sm sm:text-base hover:bg-gray-300">Quay
                lại</a>
            <!-- Submit button (needs form wrapping and POST logic) -->
            <button
                class="bg-blue-600 text-white px-3 py-1 sm:px-4 sm:py-2 rounded-lg text-sm sm:text-base hover:bg-blue-700">Nộp
                bài</button>
        </div>
    </div>

    <!-- Audio Player (Sticky) -->
    <div class="bg-white p-4 rounded-lg shadow-lg mb-6 sticky top-[130px] sm:top-[140px] z-30">
        <!-- Adjust top value -->
        <audio controls class="w-full">
            <source src="{{ audio_url }}" type="audio/mpeg">
            Trình duyệt của bạn không hỗ trợ file âm thanh.
            <!-- Add fallback for missing audio -->
            <p>Audio file not available.</p>
        </audio>
    </div>

    <!-- Question Area (Single Column, Centered) -->
    <!-- Wrap questions in a form for submission -->
    
        <div class="bg-white max-w-4xl mx-auto p-6 sm:p-10 rounded-lg shadow-lg space-y-10">

            {# --- Loop through Sections (1-4) --- #}
            {% for section_num in range(1, 5) %}
            {# Determine question range for this section #}
            {% set start_q = (section_num - 1) * 10 + 1 %}
            {% set end_q = section_num * 10 %}

            <div class="listening-section border-t pt-6 {% if not loop.first %}hidden{% endif %}"
                data-section="{{ section_num }}">
                <h3 class="text-xl sm:text-2xl font-bold mb-4 text-center">Section {{ section_num }}: Questions {{
                    start_q }}-{{ end_q }}</h3>

                {# --- Loop through Question Blocks relevant to this Section --- #}
                {% for block in question_blocks %}
                {# Check if the block range overlaps with the current section #}
                {% set range_parts = block.question_range.split('-') %}
                {% set block_start = range_parts[0]|int %}
                {% set block_end = range_parts[1]|int if range_parts|length > 1 else block_start %}

                {# Render block only if it belongs to this section #}
                {% if block_start >= start_q and block_start <= end_q %} <div
                    class="question-block mb-8 p-4 border rounded-lg bg-gray-50 shadow-sm">
                    <p class="font-semibold text-gray-700 mb-2">Questions {{ block.question_range }}</p>
                    <div class="prose prose-sm max-w-none mb-4 instruction-text">
                        {# Display instructions #}
                        {% for line in block.instruction_text.splitlines() %}
                        {% if line.strip() %} <p>{{ line | safe }}</p> {% endif %}
                        {% endfor %}
                    </div>

                    {# --- Render Input Fields Based on Type --- #}
                    {# (Similar logic to reading_test_page.html) #}

                    {# 1. Simple Types (Fill, T/F, Y/N are less common in Listening, primarily Fill) #}
                    {% if block.question_type == 'fill_in_blank' %}
                    {# Assume fill-in-blank might have multiple answers based on range #}
                    <div class="space-y-3">
                        {% for i in range(block_start, block_end + 1) %}
                        <div class="flex items-center space-x-2">
                            <label class="w-16 text-sm font-medium text-gray-700 text-right">({{ i }}):</label>
                            <input type="text" name="answer_{{ block.id }}_{{ loop.index0 }}" {# ID block + sub_index #}
                                class="flex-1 border border-gray-300 rounded-md px-3 py-1 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        </div>
                        {% endfor %}
                    </div>

                    {# 2. Multiple Choice #}
                    {% elif block.question_type == 'multiple_choice' %}
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Your Answer ({{ block.question_range
                            }}):</label>
                        {% if block.extra_data_dict.options %}
                        <select name="answer_{{ block.id }}_0" {# Assume single answer for MC block #}
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <option value="">-- Select --</option>
                            {% for option in block.extra_data_dict.options %}
                            <option value="{{ option.split('.')[0] | trim }}">{{ option }}</option>
                            {% endfor %}
                        </select>
                        {% else %}
                        <input type="text" name="answer_{{ block.id }}_0" placeholder="Enter answer choice(s)"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        {% endif %}
                    </div>

                    {# 3. Matching #}
                    {% elif block.question_type == 'matching' %}
                    {% if block.extra_data_dict.matching_items %}
                    <div class="mb-3 p-3 bg-indigo-50 border border-indigo-200 rounded text-sm">
                        <p class="font-medium mb-1">Options:</p>
                        <ul class="list-disc list-inside">
                            {% for item in block.extra_data_dict.matching_items %}
                            <li>{{ item }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% if block.extra_data_dict.sub_questions %}
                    <div class="space-y-3">
                        {% for sub_q in block.extra_data_dict.sub_questions %}
                        <div class="flex items-center space-x-2">
                            <label class="w-2/5 text-sm font-medium text-gray-700">{{ sub_q.query }}:</label>
                            <input type="text" name="answer_{{ block.id }}_{{ loop.index0 }}" {# ID block + sub_index #}
                                class="flex-1 border border-gray-300 rounded-md px-3 py-1 focus:ring-blue-500 focus:border-blue-500 text-sm"
                                placeholder="Enter match (e.g., A)">
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {# Fallback #}
                    {% else %}
                    <p class="text-red-500">Unsupported question type: {{ block.question_type }}</p>
                    {% endif %}
                    {# --- End Render Input Fields --- #}

            </div> {# End question-block #}
            {% endif %} {# End check if block in section #}
            {% endfor %} {# End loop blocks #}

            {# Display message if no blocks found for this section (unlikely if data is correct) #}
            

        </div> {# End listening-section #}
        {% endfor %} {# End loop sections 1-4 #}
</div> {# End Question Area container #}

<!-- Submit Button (Optional, can rely on header button) -->
<div class="text-center mt-6">
    <button type="submit"
        class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">
        Nộp bài
    </button>
</div>
</form> {# End Form #}


<!-- Listening Section Pagination -->
<div class="flex justify-center space-x-2 mt-8 mb-4">
    {% for section_num in range(1, 5) %}
    <button
        class="listening-page-btn px-4 py-2 rounded-lg text-sm sm:px-5 sm:py-2 sm:text-base transition
                       {% if loop.first %} bg-blue-600 text-white {% else %} bg-white text-gray-700 border border-gray-300 hover:bg-gray-100 {% endif %}"
        data-section="{{ section_num }}">
        Section {{ section_num }}
    </button>
    {% endfor %}
</div>

</div> {# End container #}

<!-- ===== JAVASCRIPT LOGIC (Inline) ===== -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ===================================
        // Logic for Listening Page (Switch Sections)
        // ===================================
        const listeningPageButtons = document.querySelectorAll('.listening-page-btn');
        const listeningSections = document.querySelectorAll('.listening-section');

        listeningPageButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const sectionNum = btn.getAttribute('data-section');

                // Update button styles
                listeningPageButtons.forEach(b => {
                    b.classList.remove('bg-blue-600', 'text-white');
                    b.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-100');
                });
                btn.classList.add('bg-blue-600', 'text-white');
                btn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300', 'hover:bg-gray-100');

                // Show/hide sections
                listeningSections.forEach(s => {
                    s.classList.toggle('hidden', s.getAttribute('data-section') !== sectionNum);
                });
                // Scroll to top of page after switching section
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });

        // ===================================
        // Timer Logic (Simple Countdown)
        // ===================================
        const timerDisplay = document.getElementById('listening-timer');
        let timeInSeconds = 40 * 60; // 40 minutes

        function updateTimer() {
            const minutes = Math.floor(timeInSeconds / 60);
            const seconds = timeInSeconds % 60;
            // Format seconds to always have two digits (e.g., 05 instead of 5)
            timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

            if (timeInSeconds > 0) {
                timeInSeconds--;
            } else {
                clearInterval(timerInterval);
                alert("Time is up!"); // Replace with a better notification later
                // Add logic to auto-submit or disable input here
            }
        }

        // Start the timer interval (updates every second)
        const timerInterval = setInterval(updateTimer, 1000);

        // Initial display update
        updateTimer();

    });
</script>
{% endblock %}