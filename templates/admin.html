{% extends 'base.html' %}

{% block title %}
Admin Panel
{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100 font-sans">

    <!-- Sidebar (Giữ nguyên) -->
    <aside class="w-64 bg-indigo-700 text-white p-6 space-y-6 flex-shrink-0">
        <h1 class="text-2xl font-bold mb-6">Admin Dashboard</h1>
        <nav class="space-y-3">
            <a href="{{ url_for('admin.admin_panel', section='users') }}"
                class="block py-2 px-3 rounded hover:bg-indigo-600 transition">👥 Quản lý người dùng</a>
            <a href="{{ url_for('admin.admin_panel', section='add_test') }}"
                class="block py-2 px-3 rounded hover:bg-indigo-600 transition">📝 Thêm đề mới</a>
            <a href="{{ url_for('index') }}" class="block py-2 px-3 rounded hover:bg-indigo-600 transition">🏠 Về
                trang chủ</a>
            <a href="{{ url_for('admin.admin_panel', section='view_tests') }}"
                class="block py-2 px-3 rounded hover:bg-indigo-600 transition">📚 Xem các đề đã thêm</a>
            <a href="{{ url_for('auth.logout') }}"
                class="block py-2 px-3 rounded hover:bg-indigo-600 transition text-red-300">🚪 Đăng xuất</a>
        </nav>
    </aside>

    <!-- Main content -->
    <main class="flex-1 p-8 overflow-y-auto">

        <!-- ===== KHỐI FLASH (Đầy đủ) ===== -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-4 space-y-2">
            {% for category, message in messages %}
            {% set alert_class = 'bg-red-100 border-red-400 text-red-700' if category == 'error' else 'bg-green-100
            border-green-400 text-green-700' %}
            <div class="{{ alert_class }} border px-4 py-3 rounded relative" role="alert">
                <span class="block sm:inline">{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- ===== PHẦN QUẢN LÝ USER (Đầy đủ) ===== -->
        {% if section == 'users' %}
        <section id="users">
            <h2 class="text-2xl font-semibold mb-4">👤 Danh sách người dùng</h2>
            {% if users %}
            <div class="overflow-x-auto">
                <table class="min-w-full border border-gray-300 bg-white rounded-lg shadow">
                    <thead class="bg-indigo-100">
                        <tr>
                            <th class="px-4 py-2 border text-left">Tên</th>
                            <th class="px-4 py-2 border text-left">Email</th>
                            <th class="px-4 py-2 border text-left">Role</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 border">{{ user.name }}</td>
                            <td class="px-4 py-2 border">{{ user.email }}</td>
                            <td class="px-4 py-2 border">{{ user.role }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-600 italic">Chưa có người dùng nào được đăng ký.</p>
            {% endif %}
        </section>
        {% endif %}

        <!-- ===== PHẦN THÊM ĐỀ MỚI (Đầy đủ với cấu trúc mới) ===== -->
        {% if section == 'add_test' %}
        <section id="add-test">
            <h2 class="text-2xl font-semibold mb-4">📝 Thêm đề mới</h2>
            <form method="POST" action="{{ url_for('admin.admin_panel') }}" enctype="multipart/form-data"
                class="bg-white p-6 rounded-lg shadow space-y-6">
                <input type="hidden" name="form_type" value="add_test">

                <!-- 1. Thông tin chung về Đề Thi -->
                <fieldset class="border rounded p-4">
                    <legend class="text-xl font-semibold text-indigo-700 px-2">1. Thông tin đề thi</legend>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-2">Tên đề (Title):</label>
                            <input type="text" name="title"
                                class="w-full border rounded px-3 py-2 focus:ring focus:ring-indigo-200" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Loại (Category):</label>
                            <select id="category-select" name="category"
                                class="w-full border rounded px-3 py-2 focus:ring focus:ring-indigo-200" required>
                                <option value="Reading">Reading</option>
                                <option value="Listening">Listening</option>
                            </select>
                        </div>
                        <div id="audio-upload-field" class="hidden">
                            <label class="block text-gray-700 mb-2">File Audio (MP3):</label>
                            <input type="file" name="audio_file" accept=".mp3"
                                class="w-full border rounded px-3 py-2 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <p class="text-xs text-gray-500 mt-1">Sẽ được lưu vào /static/audio/</p>
                        </div>
                    </div>
                </fieldset>

                <!-- 2. Vùng chứa các Passage/Section động -->
                <fieldset class="border rounded p-4">
                    <legend class="text-xl font-semibold text-indigo-700 px-2">
                        <span id="passage-section-legend">2. Các Đoạn văn (Passages)</span>
                    </legend>
                    <div id="passages-container" class="space-y-6">
                        <!-- Các passage/section động -->
                    </div>
                    <button type="button" id="add-passage-btn"
                        class="mt-4 bg-purple-500 text-white font-medium px-4 py-2 rounded hover:bg-purple-600 transition">
                        + Thêm <span id="add-passage-section-text">Đoạn văn</span>
                    </button>
                </fieldset>

                <!-- 3. Nút Submit chính -->
                <div class="text-right"> <button type="submit"
                        class="bg-indigo-600 text-white font-medium px-6 py-2 rounded hover:bg-indigo-700 transition">
                        Lưu đề thi </button> </div>
            </form>
        </section>
        {% endif %}

        <!-- ===== PHẦN XEM TEST (Đầy đủ) ===== -->
        {% if section == 'view_tests' %}
        <section id="view-tests">
            <h2 class="text-2xl font-semibold mb-4">📚 Danh sách đề thi đã thêm</h2>
            {% if tests %}
            <div class="overflow-x-auto">
                <table class="min-w-full border border-gray-300 bg-white rounded-lg shadow">
                    <thead class="bg-indigo-100">
                        <tr>
                            <th class="px-4 py-2 border text-left">Tên đề thi</th>
                            <th class="px-4 py-2 border text-left">Loại</th>
                            <th class="px-4 py-2 border text-center">Số lượt làm</th>
                            <th class="px-4 py-2 border text-center"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for test in tests %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 border">{{ test.title }}</td>
                            <td class="px-4 py-2 border">{{ test.category }}</td>
                            <td class="px-4 py-2 border text-center">{{ test.user_results | length }}</td>
                            <td class="px-4 py-2 border text-center">
                                <!-- Thêm link Xem chi tiết/Sửa/Xóa sau -->
                                <a href="{{ url_for('admin.view_test', test_id=test.id) }}" class="text-blue-600 hover:underline text-sm">Xem</a>

                                <a  href="{{ url_for('admin.delete_test', test_id=test.id) }}"
                                    class="text-red-600 hover:underline text-sm"
                                    onclick="return confirm('Bạn có chắc chắn muốn xóa đề thi này không?');">Xóa</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-600 italic">Chưa có đề thi nào được thêm vào database.</p>
            {% endif %}
        </section>
        {% endif %}

    </main>
</div>

<!-- ===== JAVASCRIPT LOGIC (Đầy đủ với cấu trúc mới) ===== -->
<script>
    // -------------------------------------------------------------------
    // BIẾN TOÀN CỤC VÀ HÀM HELPER CHUNG
    // -------------------------------------------------------------------
    let questionIdCounter = 0; // ID duy nhất cho MỌI câu hỏi trên trang
    let passageIdCounter = 0; // ID duy nhất cho MỌI passage/section
    const MAX_QUESTIONS_PER_TEST = 40; // Giới hạn tổng số câu hỏi

    // Hàm xóa chung cho passage/question
    function removeThisBlock(buttonElement, blockSelector, updateFn) {
        const blockToRemove = buttonElement.closest(blockSelector);
        if (blockToRemove) {
            blockToRemove.remove();
            if (updateFn) updateFn();
            updateAddButtonState(); // Luôn kiểm tra nút 40 câu
        } else {
            console.error("Could not find block to remove with selector:", blockSelector);
        }
    }

    // Hàm cập nhật số thứ tự câu hỏi TRONG MỖI passage/section
    function updateQuestionNumbers() {
        const allPassageBlocks = document.querySelectorAll('.passage-block');
        allPassageBlocks.forEach((passageBlock) => {
            const questionContainer = passageBlock.querySelector('.questions-container');
            if (questionContainer) {
                const questionsInPassage = questionContainer.querySelectorAll('.question-block');
                questionsInPassage.forEach((block, index) => {
                    const label = block.querySelector('.question-label');
                    if (label) {
                        label.textContent = `Câu hỏi ${index + 1}`; // Số thứ tự trong passage/section này
                    }
                });
            }
        });
    }

    // Hàm cập nhật trạng thái các nút "+ Câu hỏi" dựa trên tổng số câu hỏi
    function updateAddButtonState() {
        const allQuestionBlocks = document.querySelectorAll('.question-block');
        const addQuestionBtns = document.querySelectorAll('.add-question-btn'); // Lấy tất cả các nút thêm câu hỏi trong từng passage/section
        const totalQuestions = allQuestionBlocks.length;

        addQuestionBtns.forEach(btn => {
            const isDisabled = totalQuestions >= MAX_QUESTIONS_PER_TEST;
            btn.disabled = isDisabled;
            btn.textContent = isDisabled ? 'Đã đạt tối đa' : '+ Câu hỏi';
            btn.classList.toggle('bg-gray-400', isDisabled);
            btn.classList.toggle('hover:bg-gray-400', isDisabled);
            btn.classList.toggle('bg-green-500', !isDisabled);
            btn.classList.toggle('hover:bg-green-600', !isDisabled);
        });
    }

    // -------------------------------------------------------------------
    // CÁC HÀM "CON" (để thêm lựa chọn, thêm câu hỏi con)
    // -------------------------------------------------------------------
    let mcOptionCount = 0;
    function addMcOption(buttonElement, passageId, questionId) {
        mcOptionCount++;
        const container = buttonElement.previousElementSibling; // Find '.dynamic-options-container'
        if (!container) return;
        const optionDiv = document.createElement('div');
        optionDiv.className = 'flex items-center space-x-2';
        // Name: passages[passageId][questions][questionId][options][option_...]
        optionDiv.innerHTML = `
            <input type="text" name="passages[${passageId}][questions][${questionId}][options][option_${mcOptionCount}]" class="w-full border rounded px-3 py-2 text-sm" placeholder="Nội dung lựa chọn (ví dụ: A. ...)">
            <button type="button" onclick="this.parentElement.remove()" class="text-red-500 text-sm flex-shrink-0">Xóa</button>
        `;
        container.appendChild(optionDiv);
    }

    let subQuestionCount = 0;
    function addMatchingSubQuestion(buttonElement, passageId, questionId) {
        subQuestionCount++;
        const container = buttonElement.previousElementSibling; // Find '.sub-questions-container'
        if (!container) return;
        const subQuestionDiv = document.createElement('div');
        subQuestionDiv.className = 'flex items-center space-x-2 bg-gray-50 p-2 rounded';
        // Name: passages[passageId][questions][questionId][sub_questions][sq_...][query/answer]
        subQuestionDiv.innerHTML = `
            <input type="text" name="passages[${passageId}][questions][${questionId}][sub_questions][sq_${subQuestionCount}][query]" class="w-1/3 border rounded px-3 py-2 text-sm" placeholder="Câu hỏi (ví dụ: Đoạn A)">
            <input type="text" name="passages[${passageId}][questions][${questionId}][sub_questions][sq_${subQuestionCount}][answer]" class="w-2/3 border rounded px-3 py-2 text-sm" placeholder="Đáp án (ví dụ: iii)">
            <button type="button" onclick="this.parentElement.remove()" class="text-red-500 text-sm flex-shrink-0">Xóa</button>
        `;
        container.appendChild(subQuestionDiv);
    }

    // -------------------------------------------------------------------
    // HÀM "VẼ" TEMPLATE CHO CÂU HỎI
    // -------------------------------------------------------------------
    function createQuestionShell(passageId, questionId, type, typeLabel) {
        // Name uses internal unique questionIdCounter (via questionId param)
        // Display label uses internal ID temporarily, updated by updateQuestionNumbers()
        // onclick uses correct removeThisBlock syntax
        return `
            <input type="hidden" name="passages[${passageId}][questions][${questionId}][type]" value="${type}">
            <div class="flex justify-between items-center">
                <div>
                    <label class="question-label block text-gray-700 font-semibold mb-1">Câu hỏi ${questionId}</label> <!-- Temp label -->
                    <span class="text-sm text-indigo-600 font-medium">${typeLabel}</span>
                </div>
                <button type="button" onclick="removeThisBlock(this, '.question-block', updateQuestionNumbers)" class="text-red-500 hover:text-red-700 text-sm">Xóa câu hỏi</button>
            </div>
            <label class="block text-gray-700 text-sm">Dải câu hỏi (Range):</label>
            <input type="text" name="passages[${passageId}][questions][${questionId}][question_range]" class="w-full border rounded px-3 py-2 text-sm" placeholder="Ví dụ: 1-5 hoặc 6" required>
        `;
    }
    function createSimpleQuestionHTML(passageId, questionId, type) {
        let label = "Điền vào chỗ trống";
        if (type === 'true_false_not_given') label = "True/False/Not Given";
        if (type === 'yes_no_not_given') label = "Yes/No/Not Given";
        return `
            ${createQuestionShell(passageId, questionId, type, label)}
            <label class="block text-gray-700 text-sm">Nội dung câu hỏi/Hướng dẫn (Instruction):</label>
            <textarea name="passages[${passageId}][questions][${questionId}][query]" rows="2" class="w-full border rounded px-3 py-2 text-sm" required></textarea>
            <label class="block text-gray-700 text-sm">Đáp án đúng (Answer):</label>
            <input type="text" name="passages[${passageId}][questions][${questionId}][answer]" class="w-full border rounded px-3 py-2 text-sm" placeholder="Ví dụ: water..." required>
        `;
    }
    function createMultipleChoiceHTML(passageId, questionId) {
        return `
            ${createQuestionShell(passageId, questionId, 'multiple_choice', 'Trắc nghiệm (Động)')}
            <label class="block text-gray-700 text-sm">Nội dung câu hỏi/Hướng dẫn (Instruction):</label>
            <textarea name="passages[${passageId}][questions][${questionId}][query]" rows="2" class="w-full border rounded px-3 py-2 text-sm" required></textarea>
            <label class="block text-gray-700 text-sm">Đáp án đúng (Answer):</label>
            <input type="text" name="passages[${passageId}][questions][${questionId}][answer]" class="w-full border rounded px-3 py-2 text-sm" placeholder="Ví dụ: A" required>
            <div class="dynamic-options-container space-y-2 pl-4 border-l-2 border-indigo-200">
                <label class="block text-gray-600 text-sm font-medium">Các lựa chọn (Options):</label>
            </div>
            <button type="button" onclick="addMcOption(this, ${passageId}, ${questionId})" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">+ Thêm lựa chọn</button>
        `;
    }
    function createMatchingHTML(passageId, questionId) {
        return `
            ${createQuestionShell(passageId, questionId, 'matching', 'Matching (Nối)')}
            <label class="block text-gray-700 text-sm">Câu hỏi chính/Hướng dẫn (Instruction):</label>
            <textarea name="passages[${passageId}][questions][${questionId}][query]" rows="3" class="w-full border rounded px-3 py-2 text-sm" required></textarea>
            <label class="block text-gray-600 text-sm font-medium">Danh sách các Items:</label>
            <textarea name="passages[${passageId}][questions][${questionId}][matching_items]" rows="4" class="w-full border rounded px-3 py-2 text-sm" placeholder="Mỗi item 1 dòng..."></textarea>
            <div class="sub-questions-container space-y-3 pt-3 border-t">
                <label class="block text-gray-600 text-sm font-medium">Các câu hỏi con (Sub-questions):</label>
            </div>
            <button type="button" onclick="addMatchingSubQuestion(this, ${passageId}, ${questionId})" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">+ Thêm câu hỏi con</button>
        `;
    }

    // -------------------------------------------------------------------
    // HÀM "VẼ" TEMPLATE CHO PASSAGE/SECTION
    // -------------------------------------------------------------------
    function createPassageHTML(passageId, isListening) {
        const passageLabelDisplay = isListening ? `Section ${passageId}` : `Đoạn văn (Passage) ${passageId}`; // Label tạm thời
        const passageTextLabel = isListening ? `Ghi chú Section (tùy chọn)` : `Nội dung đoạn văn:`;
        const passageTextPlaceholder = isListening ? `Ví dụ: Phần này nói về chủ đề ABC...` : `Dán nội dung bài đọc vào đây...`;
        const removeButtonText = isListening ? 'Xóa Section' : 'Xóa Passage';

        // Name uses internal unique passageIdCounter (via passageId param)
        return `
            <div class="passage-block border rounded p-4 bg-white shadow-md space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="passage-label text-lg font-semibold text-purple-700">${passageLabelDisplay}</h3> <!-- Temp label -->
                    <button type="button" onclick="removeThisBlock(this, '.passage-block', updatePassageNumbers)" class="text-red-500 hover:text-red-700 text-sm">${removeButtonText}</button>
                </div>
                <div class="${isListening ? 'hidden' : ''}">
                    <label class="block text-gray-700 mb-1 text-sm">${passageTextLabel}</label>
                    <textarea name="passages[${passageId}][text]" rows="6" class="w-full border rounded px-3 py-2 focus:ring focus:ring-indigo-200 text-sm" placeholder="${passageTextPlaceholder}"></textarea>
                </div>
                <div class="questions-container border-t pt-4 space-y-6">
                     <h4 class="text-md font-semibold text-gray-600">Câu hỏi cho <span class="dynamic-passage-label">${passageLabelDisplay}</span></h4> <!-- Dynamic label -->
                </div>
                 <div class="mt-4 flex items-center space-x-3 p-2 bg-gray-100 rounded">
                     <label for="question-type-select-${passageId}" class="text-sm font-medium">Thêm câu hỏi loại:</label>
                     <select id="question-type-select-${passageId}" class="border rounded px-2 py-1 text-sm">
                         <option value="fill_in_blank">Điền trống</option>
                         <option value="multiple_choice">Trắc nghiệm</option>
                         <option value="true_false_not_given">T/F/NG</option>
                         <option value="yes_no_not_given">Y/N/NG</option>
                         <option value="matching">Matching</option>
                     </select>
                     <button type="button" onclick="addQuestionToPassage(${passageId})"
                        class="add-question-btn bg-green-500 text-white font-medium px-3 py-1 rounded text-sm hover:bg-green-600 transition">
                        + Câu hỏi
                     </button>
                 </div>
            </div>`;
    }

    // -------------------------------------------------------------------
    // HÀM CẬP NHẬT SỐ THỨ TỰ PASSAGE/SECTION VÀ CÁC LABEL LIÊN QUAN
    // -------------------------------------------------------------------
    function updatePassageNumbers() {
        const container = document.getElementById('passages-container');
        if (!container) return;
        const allPassageBlocks = container.querySelectorAll('.passage-block');
        const isListening = document.getElementById('category-select').value === 'Listening';

        allPassageBlocks.forEach((block, index) => {
            const displayIndex = index + 1;
            const label = block.querySelector('.passage-label');
            const dynamicLabelSpan = block.querySelector('.dynamic-passage-label'); // Label trong vùng câu hỏi
            const removeButton = block.querySelector('button[onclick*="removeThisBlock"]'); // Nút xóa

            const passageLabelText = isListening ? `Section ${displayIndex}` : `Đoạn văn (Passage) ${displayIndex}`;

            if (label) label.textContent = passageLabelText;
            if (dynamicLabelSpan) dynamicLabelSpan.textContent = passageLabelText;
            if (removeButton) removeButton.textContent = isListening ? 'Xóa Section' : 'Xóa Passage';

        });
        // Cập nhật text nút thêm và legend
        const addBtnText = document.getElementById('add-passage-section-text');
        if (addBtnText) addBtnText.textContent = isListening ? 'Section' : 'Đoạn văn';
        const legendText = document.getElementById('passage-section-legend');
        if (legendText) legendText.textContent = isListening ? '2. Các Section' : '2. Các Đoạn văn (Passages)';
    }

    // -------------------------------------------------------------------
    // HÀM THÊM CÂU HỎI VÀO PASSAGE/SECTION
    // -------------------------------------------------------------------
    function addQuestionToPassage(passageId) {
        // Tìm passage block dựa trên ID duy nhất đã gán khi tạo
        const passageBlock = document.querySelector(`.passage-block[data-passage-id="${passageId}"]`);
        if (!passageBlock) {
            console.error(`Could not find passage block with data-passage-id=${passageId}`);
            return;
        }

        const questionContainer = passageBlock.querySelector('.questions-container');
        const typeSelect = passageBlock.querySelector(`#question-type-select-${passageId}`);
        if (!questionContainer || !typeSelect) return;

        if (document.querySelectorAll('.question-block').length >= MAX_QUESTIONS_PER_TEST) {
            alert(`Đã đạt tối đa ${MAX_QUESTIONS_PER_TEST} câu hỏi cho toàn bộ bài test.`);
            return;
        }

        questionIdCounter++; // ID câu hỏi toàn cục luôn tăng
        const selectedType = typeSelect.value;

        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-block border rounded p-3 bg-gray-50 space-y-2 shadow-sm';
        let questionHTML = '';

        switch (selectedType) {
            case 'fill_in_blank':
            case 'true_false_not_given':
            case 'yes_no_not_given':
                questionHTML = createSimpleQuestionHTML(passageId, questionIdCounter, selectedType);
                break;
            case 'multiple_choice':
                questionHTML = createMultipleChoiceHTML(passageId, questionIdCounter);
                break;
            case 'matching':
                questionHTML = createMatchingHTML(passageId, questionIdCounter);
                break;
        }

        questionDiv.innerHTML = questionHTML;
        questionContainer.appendChild(questionDiv);
        updateQuestionNumbers(); // Cập nhật số thứ tự câu hỏi trong passage này
        updateAddButtonState();
    }


    // -------------------------------------------------------------------
    // HÀM CHÍNH (Main execution)
    // -------------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', function () {
        const categorySelect = document.getElementById('category-select');
        const audioUploadField = document.getElementById('audio-upload-field');
        const addPassageBtn = document.getElementById('add-passage-btn');
        const passagesContainer = document.getElementById('passages-container');

        // --- Logic ẩn/hiện trường Upload và thay đổi text ---
        function toggleFieldsAndLabels() {
            if (!categorySelect || !audioUploadField || !passagesContainer) return; // Guard clause

            const isListening = categorySelect.value === 'Listening';
            audioUploadField.classList.toggle('hidden', !isListening);

            // Xóa hết passage/section cũ khi đổi category
            passagesContainer.innerHTML = '';
            passageIdCounter = 0; // Reset ID passage
            questionIdCounter = 0; // Reset ID question để bắt đầu lại từ 1 cho category mới
            updatePassageNumbers();
            updateAddButtonState();
        }

        if (categorySelect) {
            toggleFieldsAndLabels();
            categorySelect.addEventListener('change', toggleFieldsAndLabels);
        } else {
            console.error("Category select element not found!");
        }

        // --- Logic thêm Passage/Section ---
        if (addPassageBtn && passagesContainer) {
            addPassageBtn.addEventListener('click', function () {
                passageIdCounter++; // ID passage/section luôn tăng
                const isListening = categorySelect.value === 'Listening';
                const passageHTML = createPassageHTML(passageIdCounter, isListening);
                const tempDiv = document.createElement('div'); // Tạo div tạm để chứa HTML
                tempDiv.innerHTML = passageHTML.trim(); // Parse HTML string
                const passageElement = tempDiv.firstChild; // Lấy element .passage-block

                // Gán ID duy nhất vào data attribute để hàm addQuestionToPassage tìm thấy
                if (passageElement && passageElement.classList.contains('passage-block')) {
                    passageElement.setAttribute('data-passage-id', passageIdCounter);
                    passagesContainer.appendChild(passageElement);
                    updatePassageNumbers();
                } else {
                    console.error("Failed to create passage element from HTML");
                }
            });
        } else {
            if (!addPassageBtn) console.error("Add passage button not found!");
            if (!passagesContainer) console.error("Passages container not found!");
        }

        // Gọi hàm kiểm tra nút 40 câu khi tải trang
        updateAddButtonState();

    }); // <-- DẤU ĐÓNG CỦA DOMContentLoaded
</script>
{% endblock %}