{% extends 'base.html' %}

{% block title %}
Admin Panel
{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100 font-sans">

    <!-- Sidebar (Gi·ªØ nguy√™n) -->
    <aside class="w-64 bg-indigo-700 text-white p-6 space-y-6 flex-shrink-0">
        <h1 class="text-2xl font-bold mb-6">Admin Dashboard</h1>
        <nav class="space-y-3">
            <a href="{{ url_for('admin.admin_panel', section='users') }}"
                class="block py-2 px-3 rounded hover:bg-indigo-600 transition">üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
            <a href="{{ url_for('admin.admin_panel', section='add_test') }}"
                class="block py-2 px-3 rounded hover:bg-indigo-600 transition">üìù Th√™m ƒë·ªÅ m·ªõi</a>
            <a href="{{ url_for('index') }}" class="block py-2 px-3 rounded hover:bg-indigo-600 transition">üè† V·ªÅ
                trang ch·ªß</a>
            <a href="{{ url_for('admin.admin_panel', section='view_tests') }}"
                class="block py-2 px-3 rounded hover:bg-indigo-600 transition">üìö Xem c√°c ƒë·ªÅ ƒë√£ th√™m</a>
            <a href="{{ url_for('auth.logout') }}"
                class="block py-2 px-3 rounded hover:bg-indigo-600 transition text-red-300">üö™ ƒêƒÉng xu·∫•t</a>
        </nav>
    </aside>

    <!-- Main content -->
    <main class="flex-1 p-8 overflow-y-auto">

        <!-- ===== KH·ªêI FLASH (Gi·ªØ nguy√™n) ===== -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-4 space-y-2">
            {% for category, message in messages %}
            {% set alert_class = 'bg-red-100 border-red-400 text-red-700' if category == 'error' else 'bg-green-100
            border-green-400 text-green-700' %}
            <div class="{{ alert_class }} border px-4 py-3 rounded relative" role="alert">
                <span class="block sm:inline">{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- ===== PH·∫¶N QU·∫¢N L√ù USER (ƒê·∫ßy ƒë·ªß) ===== -->
        {% if section == 'users' %}
        <section id="users">
            <!-- ... (Code b·∫£ng user y h·ªát) ... -->
            <h2 class="text-2xl font-semibold mb-4">üë§ Danh s√°ch ng∆∞·ªùi d√πng</h2>
            {% if users %}
            <div class="overflow-x-auto">
                <table class="min-w-full border border-gray-300 bg-white rounded-lg shadow">
                    <thead class="bg-indigo-100">
                        <tr>
                            <th class="px-4 py-2 border">T√™n</th>
                            <th class="px-4 py-2 border">Email</th>
                            <th class="px-4 py-2 border">Role</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 border">{{ user.name }}</td>
                            <td class="px-4 py-2 border">{{ user.email }}</td>
                            <td class="px-4 py-2 border">{{ user.role }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-600 italic">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o ƒë∆∞·ª£c ƒëƒÉng k√Ω.</p>
            {% endif %}
        </section>
        {% endif %}

        <!-- ===== PH·∫¶N TH√äM ƒê·ªÄ M·ªöI (ƒê·∫ßy ƒë·ªß) ===== -->
        {% if section == 'add_test' %}
        <section id="add-test">
            <h2 class="text-2xl font-semibold mb-4">üìù Th√™m ƒë·ªÅ m·ªõi</h2>
            <!-- (S·ª¨A) Th√™m enctype -->
            <form method="POST" action="{{ url_for('admin.admin_panel') }}" enctype="multipart/form-data"
                class="bg-white p-6 rounded-lg shadow space-y-6">
                <input type="hidden" name="form_type" value="add_test">

                <!-- 1. Th√¥ng tin chung v·ªÅ ƒê·ªÅ Thi -->
                <fieldset class="border rounded p-4">
                    <legend class="text-xl font-semibold text-indigo-700 px-2">1. Th√¥ng tin ƒë·ªÅ thi</legend>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-2">T√™n ƒë·ªÅ (Title):</label>
                            <input type="text" name="title"
                                class="w-full border rounded px-3 py-2 focus:ring focus:ring-indigo-200" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Lo·∫°i (Category):</label>
                            <!-- (S·ª¨A) Th√™m id="category-select" -->
                            <select id="category-select" name="category"
                                class="w-full border rounded px-3 py-2 focus:ring focus:ring-indigo-200" required>
                                <option value="Reading">Reading</option>
                                <option value="Listening">Listening</option>
                            </select>
                        </div>
                        <!-- (S·ª¨A) Tr∆∞·ªùng upload audio ƒë·∫∑t ·ªü ƒë√¢y -->
                        <div id="audio-upload-field" class="hidden">
                            <label class="block text-gray-700 mb-2">File Audio (MP3):</label>
                            <input type="file" name="audio_file" accept=".mp3"
                                class="w-full border rounded px-3 py-2 focus:ring focus:ring-indigo-200 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <p class="text-xs text-gray-500 mt-1">Ch·ªâ ch·∫•p nh·∫≠n file .mp3. S·∫Ω ƒë∆∞·ª£c l∆∞u v√†o
                                /static/audio/</p>
                        </div>
                    </div>
                </fieldset>

                <!-- 2. Th√¥ng tin ƒêo·∫°n vƒÉn -->
                <!-- (S·ª¨A) Th√™m id="passage-field" -->
                <fieldset id="passage-field" class="border rounded p-4">
                    <legend class="text-xl font-semibold text-indigo-700 px-2">2. ƒêo·∫°n vƒÉn Passage</legend>
                    <div>
                        <label class="block text-gray-700 mb-2">N·ªôi dung ƒëo·∫°n vƒÉn:</label>
                        <textarea name="passage_text" rows="8"
                            class="w-full border rounded px-3 py-2 focus:ring focus:ring-indigo-200"
                            placeholder="D√°n n·ªôi dung b√†i ƒë·ªçc Reading v√†o ƒë√¢y..."></textarea>
                    </div>
                </fieldset>

                <!-- 3. V√πng ch·ª©a c√°c c√¢u h·ªèi ƒë·ªông -->
                <fieldset class="border rounded p-4">
                    <legend class="text-xl font-semibold text-indigo-700 px-2">3. C√¢u h·ªèi (Questions)</legend>
                    <div id="questions-container" class="space-y-6">
                        <!-- C√°c c√¢u h·ªèi ƒë·ªông s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y -->
                    </div>
                    <div class="mt-6 flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                        <label for="question-type-select" class="font-medium">Ch·ªçn lo·∫°i c√¢u h·ªèi:</label>
                        <select id="question-type-select"
                            class="border rounded px-3 py-2 focus:ring focus:ring-indigo-200">
                            <option value="fill_in_blank">ƒêi·ªÅn v√†o ch·ªó tr·ªëng</option>
                            <option value="multiple_choice">Tr·∫Øc nghi·ªám (ƒê·ªông)</option>
                            <option value="true_false_not_given">True/False/NG</option>
                            <option value="yes_no_not_given">Yes/No/NG</option>
                            <option value="matching">Matching (N·ªëi)</option>
                        </select>
                        <button type="button" id="add-question-btn"
                            class="bg-green-500 text-white font-medium px-4 py-2 rounded hover:bg-green-600 transition">
                            + Th√™m c√¢u h·ªèi
                        </button>
                    </div>
                </fieldset>

                <!-- 4. N√∫t Submit ch√≠nh -->
                <div class="text-right"> <button type="submit"
                        class="bg-indigo-600 text-white font-medium px-6 py-2 rounded hover:bg-indigo-700 transition">
                        L∆∞u ƒë·ªÅ thi
                    </button> </div>
            </form>
        </section>
        {% endif %}

        <!-- ===== PH·∫¶N XEM TEST (ƒê·∫ßy ƒë·ªß) ===== -->
        {% if section == 'view_tests' %}
        <section id="view-tests">
            <!-- ... (Code xem test y h·ªát) ... -->
            <h2 class="text-2xl font-semibold mb-4">üìö Danh s√°ch ƒë·ªÅ thi ƒë√£ th√™m</h2>
            {% if tests %}
            <div class="bg-white rounded-lg shadow p-4">
                <ul class="space-y-3">
                    {% for test in tests %}
                    <li class="border-b pb-2">
                        <h3 class="text-lg font-medium text-indigo-700">{{ test.title }}</h3>
                        <p class="text-sm text-gray-600">Lo·∫°i: {{ test.category }}</p>
                        <p class="text-sm text-gray-500">
                            S·ªë ƒëo·∫°n vƒÉn: {{ test.passages | length }}
                            <!-- C√≥ th·ªÉ th√™m n√∫t Xem chi ti·∫øt/S·ª≠a/X√≥a ·ªü ƒë√¢y -->
                        </p>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% else %}
            <p class="text-gray-600 italic">Ch∆∞a c√≥ ƒë·ªÅ thi n√†o ƒë∆∞·ª£c th√™m v√†o database.</p>
            {% endif %}
        </section>
        {% endif %}

    </main>
</div>

<!-- ===== JAVASCRIPT LOGIC (ƒê√É S·ª¨A L·∫†I C·∫§U TR√öC) ===== -->
<script>
    // -------------------------------------------------------------------
    // C√ÅC H√ÄM TR·ª¢ GI√öP (Helpers) - Kh√¥ng ƒë·ªïi
    // -------------------------------------------------------------------
    function removeThisQuestion(buttonElement) { /* ... Gi·ªØ nguy√™n ... */ }
    function updateQuestionNumbers() { /* ... Gi·ªØ nguy√™n ... */ }
    function updateAddButtonState() { /* ... Gi·ªØ nguy√™n ... */ }

    // H√†m X√≥a c√¢u h·ªèi
    function removeThisQuestion(buttonElement) {
        buttonElement.closest('.question-block').remove();
        updateQuestionNumbers();
        updateAddButtonState();
    }

    // H√†m C·∫≠p nh·∫≠t s·ªë th·ª© t·ª±
    function updateQuestionNumbers() {
        const container = document.getElementById('questions-container');
        if (!container) return;
        const allQuestionBlocks = container.querySelectorAll('.question-block');
        allQuestionBlocks.forEach((block, index) => {
            const label = block.querySelector('.question-label');
            if (label) {
                label.textContent = `C√¢u h·ªèi ${index + 1}`;
            }
        });
    }

    // H√†m ki·ªÉm tra 40 c√¢u
    function updateAddButtonState() {
        const container = document.getElementById('questions-container');
        if (!container) return;
        const addQuestionBtn = document.getElementById('add-question-btn');
        const currentCount = container.querySelectorAll('.question-block').length;
        const MAX_QUESTIONS_FRONTEND = 40;

        if (currentCount >= MAX_QUESTIONS_FRONTEND) {
            addQuestionBtn.disabled = true;
            addQuestionBtn.textContent = 'ƒê√£ ƒë·∫°t t·ªëi ƒëa 40 c√¢u';
            addQuestionBtn.classList.add('bg-gray-400', 'hover:bg-gray-400');
            addQuestionBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
        } else {
            addQuestionBtn.disabled = false;
            addQuestionBtn.textContent = '+ Th√™m c√¢u h·ªèi';
            addQuestionBtn.classList.remove('bg-gray-400', 'hover:bg-gray-400');
            addQuestionBtn.classList.add('bg-green-500', 'hover:bg-green-600');
        }
    }


    // -------------------------------------------------------------------
    // C√ÅC H√ÄM "CON" (ƒë·ªÉ th√™m l·ª±a ch·ªçn, th√™m c√¢u h·ªèi con) - Kh√¥ng ƒë·ªïi
    // -------------------------------------------------------------------
    let mcOptionCount = 0;
    function addMcOption(buttonElement, questionId) { /* ... Gi·ªØ nguy√™n ... */ }
    let subQuestionCount = 0;
    function addMatchingSubQuestion(buttonElement, questionId) { /* ... Gi·ªØ nguy√™n ... */ }

    function addMcOption(buttonElement, questionId) {
        mcOptionCount++;
        const container = buttonElement.previousElementSibling;
        const optionDiv = document.createElement('div');
        optionDiv.className = 'flex items-center space-x-2';
        optionDiv.innerHTML = `
            <input type="text" name="questions[${questionId}][options][option_${mcOptionCount}]" class="w-full border rounded px-3 py-2 text-sm" placeholder="N·ªôi dung l·ª±a ch·ªçn (v√≠ d·ª•: A. ...)">
            <button type="button" onclick="this.parentElement.remove()" class="text-red-500 text-sm">X√≥a</button>
        `;
        container.appendChild(optionDiv);
    }

    function addMatchingSubQuestion(buttonElement, questionId) {
        subQuestionCount++;
        const container = buttonElement.previousElementSibling;
        const subQuestionDiv = document.createElement('div');
        subQuestionDiv.className = 'flex items-center space-x-2 bg-gray-50 p-2 rounded';
        subQuestionDiv.innerHTML = `
            <input type="text" name="questions[${questionId}][sub_questions][sq_${subQuestionCount}][query]" class="w-1/3 border rounded px-3 py-2 text-sm" placeholder="C√¢u h·ªèi (v√≠ d·ª•: ƒêo·∫°n A)">
            <input type="text" name="questions[${questionId}][sub_questions][sq_${subQuestionCount}][answer]" class="w-2/3 border rounded px-3 py-2 text-sm" placeholder="ƒê√°p √°n (v√≠ d·ª•: iii)">
            <button type="button" onclick="this.parentElement.remove()" class="text-red-500 text-sm">X√≥a</button>
        `;
        container.appendChild(subQuestionDiv);
    }


    // -------------------------------------------------------------------
    // C√ÅC H√ÄM "V·∫º" KHU√îN M·∫™U (Templates) - Kh√¥ng ƒë·ªïi
    // -------------------------------------------------------------------
    function createQuestionShell(id, type, typeLabel) { /* ... Gi·ªØ nguy√™n ... */ }
    function createSimpleQuestionHTML(id, type) { /* ... Gi·ªØ nguy√™n ... */ }
    function createMultipleChoiceHTML(id) { /* ... Gi·ªØ nguy√™n ... */ }
    function createMatchingHTML(id) { /* ... Gi·ªØ nguy√™n ... */ }

    function createQuestionShell(id, type, typeLabel) {
        return `
            <input type="hidden" name="questions[${id}][type]" value="${type}">
            <div class="flex justify-between items-center">
                <div>
                    <label class="question-label block text-gray-700 font-semibold mb-1">C√¢u h·ªèi ${id}</label>
                    <span class="text-sm text-indigo-600 font-medium">${typeLabel}</span>
                </div>
                <button type="button" onclick="removeThisQuestion(this)" class="text-red-500 hover:text-red-700 text-sm">X√≥a</button>
            </div>
            <label class="block text-gray-700 text-sm">D·∫£i c√¢u h·ªèi (Question Range):</label>
            <input type="text" name="questions[${id}][question_range]" class="w-full border rounded px-3 py-2 text-sm" placeholder="V√≠ d·ª•: 1-5 (cho nh√≥m) ho·∫∑c 6 (cho c√¢u ƒë∆°n)" required>
        `;
    }

    function createSimpleQuestionHTML(id, type) {
        let label = "ƒêi·ªÅn v√†o ch·ªó tr·ªëng";
        if (type === 'true_false_not_given') label = "True/False/Not Given";
        if (type === 'yes_no_not_given') label = "Yes/No/Not Given";
        return `
            ${createQuestionShell(id, type, label)}
            <label class="block text-gray-700 text-sm">N·ªôi dung c√¢u h·ªèi/H∆∞·ªõng d·∫´n (Instruction):</label>
            <textarea name="questions[${id}][query]" rows="2" class="w-full border rounded px-3 py-2 text-sm" required></textarea>
            <label class="block text-gray-700 text-sm">ƒê√°p √°n ƒë√∫ng (Answer):</label>
            <input type="text" name="questions[${id}][answer]" class="w-full border rounded px-3 py-2 text-sm" placeholder="V√≠ d·ª•: water (ho·∫∑c True, False, Not Given...)" required>
        `;
    }

    function createMultipleChoiceHTML(id) {
        return `
            ${createQuestionShell(id, 'multiple_choice', 'Tr·∫Øc nghi·ªám (ƒê·ªông)')}
            <label class="block text-gray-700 text-sm">N·ªôi dung c√¢u h·ªèi/H∆∞·ªõng d·∫´n (Instruction):</label>
            <textarea name="questions[${id}][query]" rows="2" class="w-full border rounded px-3 py-2 text-sm" required></textarea>
            <label class="block text-gray-700 text-sm">ƒê√°p √°n ƒë√∫ng (Answer):</label>
            <input type="text" name="questions[${id}][answer]" class="w-full border rounded px-3 py-2 text-sm" placeholder="V√≠ d·ª•: A (ho·∫∑c A,C n·∫øu nhi·ªÅu ƒë√°p √°n)" required>
            <div class="dynamic-options-container space-y-2 pl-4 border-l-2 border-indigo-200">
                <label class="block text-gray-600 text-sm font-medium">C√°c l·ª±a ch·ªçn (Options):</label>
            </div>
            <button type="button" onclick="addMcOption(this, ${id})" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">+ Th√™m l·ª±a ch·ªçn</button>
        `;
    }

    function createMatchingHTML(id) {
        return `
            ${createQuestionShell(id, 'matching', 'Matching (N·ªëi)')}
            <label class="block text-gray-700 text-sm">C√¢u h·ªèi ch√≠nh/H∆∞·ªõng d·∫´n (Instruction):</label>
            <textarea name="questions[${id}][query]" rows="3" class="w-full border rounded px-3 py-2 text-sm"
                placeholder="V√≠ d·ª•: N·ªëi c√°c ti√™u ƒë·ªÅ (i-v) v·ªõi c√°c ƒëo·∫°n vƒÉn (A-D)..." required></textarea>
            <label class="block text-gray-600 text-sm font-medium">Danh s√°ch c√°c Items:</label>
            <textarea name="questions[${id}][matching_items]" rows="4" class="w-full border rounded px-3 py-2 text-sm"
                placeholder="D√°n danh s√°ch c√°c items v√†o ƒë√¢y (m·ªói item 1 d√≤ng)..."></textarea>
            <div class="sub-questions-container space-y-3 pt-3 border-t">
                <label class="block text-gray-600 text-sm font-medium">C√°c c√¢u h·ªèi con (Sub-questions):</label>
            </div>
            <button type="button" onclick="addMatchingSubQuestion(this, ${id})" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">+ Th√™m c√¢u h·ªèi con</button>
        `;
    }

    // -------------------------------------------------------------------
    // H√ÄM CH√çNH (Main execution) - ƒê√É S·ª¨A L·∫†I C·∫§U TR√öC
    // -------------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', function () {
        const addQuestionBtn = document.getElementById('add-question-btn');
        const questionsContainer = document.getElementById('questions-container');
        const questionTypeSelect = document.getElementById('question-type-select');
        // (S·ª¨A) L·∫•y c√°c element m·ªõi ·ªü ƒë√¢y
        const categorySelect = document.getElementById('category-select');
        const audioUploadField = document.getElementById('audio-upload-field');
        const passageField = document.getElementById('passage-field');

        let questionIdCounter = 0; // ID n·ªôi b·ªô duy nh·∫•t

        // --- Logic th√™m c√¢u h·ªèi ---
        addQuestionBtn.addEventListener('click', function () {
            if (questionsContainer.querySelectorAll('.question-block').length >= 40) return;
            questionIdCounter += 1;
            const selectedType = questionTypeSelect.value;
            const questionBlock = document.createElement('div');
            questionBlock.className = 'question-block border rounded p-4 bg-gray-50 space-y-3';
            let questionHTML = '';
            switch (selectedType) {
                case 'fill_in_blank':
                case 'true_false_not_given':
                case 'yes_no_not_given':
                    questionHTML = createSimpleQuestionHTML(questionIdCounter, selectedType);
                    break;
                case 'multiple_choice':
                    questionHTML = createMultipleChoiceHTML(questionIdCounter);
                    break;
                case 'matching':
                    questionHTML = createMatchingHTML(questionIdCounter);
                    break;
            }
            questionBlock.innerHTML = questionHTML;
            questionsContainer.appendChild(questionBlock);
            updateQuestionNumbers();
            updateAddButtonState();
        });

        // --- (S·ª¨A) Logic ·∫©n/hi·ªán tr∆∞·ªùng Upload ---
        function toggleFields() {
            // Th√™m ki·ªÉm tra null ph√≤ng tr∆∞·ªùng h·ª£p element kh√¥ng t·ªìn t·∫°i
            if (!categorySelect || !audioUploadField || !passageField) {
                console.error("Missing required elements for toggleFields");
                return;
            }

            if (categorySelect.value === 'Listening') {
                audioUploadField.classList.remove('hidden');
                passageField.classList.add('hidden');
            } else {
                audioUploadField.classList.add('hidden');
                passageField.classList.remove('hidden');
            }
        }

        // G·ªçi khi t·∫£i trang
        toggleFields();
        // G·ªçi khi select thay ƒë·ªïi (ki·ªÉm tra null tr∆∞·ªõc khi add listener)
        if (categorySelect) {
            categorySelect.addEventListener('change', toggleFields);
        }

        // G·ªçi h√†m ki·ªÉm tra n√∫t 40 c√¢u khi t·∫£i trang
        updateAddButtonState();

    }); // <-- D·∫§U ƒê√ìNG C·ª¶A DOMContentLoaded
</script>
{% endblock %}