{% extends 'base.html' %}

{% block title %}
Admin Panel
{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100 font-sans">

    <!-- Sidebar (Gi·ªØ nguy√™n) -->
    <aside class="w-64 bg-indigo-700 text-white p-6 space-y-6 flex-shrink-0">
        <h1 class="text-2xl font-bold mb-6">Admin Dashboard</h1>
        <nav class="space-y-3">
            <a href="{{ url_for('admin.admin_panel', section='users') }}"
                class="block py-2 px-3 rounded hover:bg-indigo-600 transition">üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
            <a href="{{ url_for('admin.admin_panel', section='add_test') }}"
                class="block py-2 px-3 rounded hover:bg-indigo-600 transition">üìù Th√™m ƒë·ªÅ m·ªõi</a>
            <a href="{{ url_for('index') }}" class="block py-2 px-3 rounded hover:bg-indigo-600 transition">üè† V·ªÅ
                trang ch·ªß</a>
            <a href="{{ url_for('admin.admin_panel', section='view_tests') }}"
                class="block py-2 px-3 rounded hover:bg-indigo-600 transition">üìö Xem c√°c ƒë·ªÅ ƒë√£ th√™m</a>
            <a href="{{ url_for('auth.logout') }}"
                class="block py-2 px-3 rounded hover:bg-indigo-600 transition text-red-300">üö™ ƒêƒÉng xu·∫•t</a>
        </nav>
    </aside>

    <!-- Main content -->
    <main class="flex-1 p-8 overflow-y-auto">

        <!-- ===== KH·ªêI FLASH (ƒê·∫ßy ƒë·ªß) ===== -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-4 space-y-2">
            {% for category, message in messages %}
            {% set alert_class = 'bg-red-100 border-red-400 text-red-700' if category == 'error' else 'bg-green-100
            border-green-400 text-green-700' %}
            <div class="{{ alert_class }} border px-4 py-3 rounded relative" role="alert">
                <span class="block sm:inline">{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- ===== PH·∫¶N QU·∫¢N L√ù USER (ƒê·∫ßy ƒë·ªß) ===== -->
        {% if section == 'users' %}
        <section id="users">
            <h2 class="text-2xl font-semibold mb-4">üë§ Danh s√°ch ng∆∞·ªùi d√πng</h2>
            {% if users %}
            <div class="overflow-x-auto">
                <table class="min-w-full border border-gray-300 bg-white rounded-lg shadow">
                    <thead class="bg-indigo-100">
                        <tr>
                            <th class="px-4 py-2 border text-left">T√™n</th>
                            <th class="px-4 py-2 border text-left">Email</th>
                            <th class="px-4 py-2 border text-left">Role</th>
                            <th class="px-4 py-2 border text-center">H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 border">{{ user.name }}</td>
                            <td class="px-4 py-2 border">{{ user.email }}</td>
                            <td class="px-4 py-2 border">{{ user.role }}</td>
                            <td class="px-4 py-2 border" >
                                <a href="{{ url_for('admin.view_user', user_id=user.id) }}"
                                    class="text-blue-600 hover:underline text-sm mr-2">Xem</a>

                                {% if user.id != session.user_id %}
                                <a href="{{ url_for('admin.delete_user', user_id=user.id) }}"
                                    class="text-red-600 hover:underline text-sm"
                                    onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y kh√¥ng? T·∫•t c·∫£ k·∫øt qu·∫£ l√†m b√†i c·ªßa h·ªç c≈©ng s·∫Ω b·ªã x√≥a.');">X√≥a</a>
                                {% else %}
                                <span class="text-gray-400 text-sm">(B·∫°n)</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-600 italic">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o ƒë∆∞·ª£c ƒëƒÉng k√Ω.</p>
            {% endif %}
        </section>
        {% endif %}

        <!-- ===== PH·∫¶N TH√äM ƒê·ªÄ M·ªöI (ƒê·∫ßy ƒë·ªß v·ªõi c·∫•u tr√∫c m·ªõi) ===== -->
        {% if section == 'add_test' %}
        <section id="add-test">
            <h2 class="text-2xl font-semibold mb-4">üìù Th√™m ƒë·ªÅ m·ªõi</h2>
            <form method="POST" action="{{ url_for('admin.admin_panel') }}" enctype="multipart/form-data"
                class="bg-white p-6 rounded-lg shadow space-y-6">
                <input type="hidden" name="form_type" value="add_test">

                <!-- 1. Th√¥ng tin chung v·ªÅ ƒê·ªÅ Thi -->
                <fieldset class="border rounded p-4">
                    <legend class="text-xl font-semibold text-indigo-700 px-2">1. Th√¥ng tin ƒë·ªÅ thi</legend>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-2">T√™n ƒë·ªÅ (Title):</label>
                            <input type="text" name="title"
                                class="w-full border rounded px-3 py-2 focus:ring focus:ring-indigo-200" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Lo·∫°i (Category):</label>
                            <select id="category-select" name="category"
                                class="w-full border rounded px-3 py-2 focus:ring focus:ring-indigo-200" required>
                                <option value="Reading">Reading</option>
                                <option value="Listening">Listening</option>
                            </select>
                        </div>
                        <div id="audio-upload-field" class="hidden">
                            <label class="block text-gray-700 mb-2">File Audio (MP3):</label>
                            <input type="file" name="audio_file" accept=".mp3"
                                class="w-full border rounded px-3 py-2 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <p class="text-xs text-gray-500 mt-1">S·∫Ω ƒë∆∞·ª£c l∆∞u v√†o /static/audio/</p>
                        </div>
                    </div>
                </fieldset>

                <!-- 2. V√πng ch·ª©a c√°c Passage/Section ƒë·ªông -->
                <fieldset class="border rounded p-4">
                    <legend class="text-xl font-semibold text-indigo-700 px-2">
                        <span id="passage-section-legend">2. C√°c ƒêo·∫°n vƒÉn (Passages)</span>
                    </legend>
                    <div id="passages-container" class="space-y-6">
                        <!-- C√°c passage/section ƒë·ªông -->
                    </div>
                    <button type="button" id="add-passage-btn"
                        class="mt-4 bg-purple-500 text-white font-medium px-4 py-2 rounded hover:bg-purple-600 transition">
                        + Th√™m <span id="add-passage-section-text">ƒêo·∫°n vƒÉn</span>
                    </button>
                </fieldset>

                <!-- 3. N√∫t Submit ch√≠nh -->
                <div class="text-right"> <button type="submit"
                        class="bg-indigo-600 text-white font-medium px-6 py-2 rounded hover:bg-indigo-700 transition">
                        L∆∞u ƒë·ªÅ thi </button> </div>
            </form>
        </section>
        {% endif %}

        <!-- ===== PH·∫¶N XEM TEST (ƒê·∫ßy ƒë·ªß) ===== -->
        {% if section == 'view_tests' %}
        <section id="view-tests">
            <h2 class="text-2xl font-semibold mb-4">üìö Danh s√°ch ƒë·ªÅ thi ƒë√£ th√™m</h2>
            {% if tests %}
            <div class="overflow-x-auto">
                <table class="min-w-full border border-gray-300 bg-white rounded-lg shadow">
                    <thead class="bg-indigo-100">
                        <tr>
                            <th class="px-4 py-2 border text-left">T√™n ƒë·ªÅ thi</th>
                            <th class="px-4 py-2 border text-left">Lo·∫°i</th>
                            <th class="px-4 py-2 border text-center">S·ªë l∆∞·ª£t l√†m</th>
                            <th class="px-4 py-2 border text-center"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for test in tests %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 border">{{ test.title }}</td>
                            <td class="px-4 py-2 border">{{ test.category }}</td>
                            <td class="px-4 py-2 border text-center">{{ test.user_results | length }}</td>
                            <td class="px-4 py-2 border text-center">
                                <!-- Th√™m link Xem chi ti·∫øt/S·ª≠a/X√≥a sau -->
                                <a href="{{ url_for('admin.view_test', test_id=test.id) }}"
                                    class="text-blue-600 hover:underline text-sm">Xem</a>

                                <a href="{{ url_for('admin.delete_test', test_id=test.id) }}"
                                    class="text-red-600 hover:underline text-sm"
                                    onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë·ªÅ thi n√†y kh√¥ng?');">X√≥a</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-600 italic">Ch∆∞a c√≥ ƒë·ªÅ thi n√†o ƒë∆∞·ª£c th√™m v√†o database.</p>
            {% endif %}
        </section>
        {% endif %}

    </main>
</div>

<!-- ===== JAVASCRIPT LOGIC (ƒê·∫ßy ƒë·ªß v·ªõi c·∫•u tr√∫c m·ªõi) ===== -->
<script>
    // -------------------------------------------------------------------
    // BI·∫æN TO√ÄN C·ª§C V√Ä H√ÄM HELPER CHUNG
    // -------------------------------------------------------------------
    let questionIdCounter = 0; // ID duy nh·∫•t cho M·ªåI c√¢u h·ªèi tr√™n trang
    let passageIdCounter = 0; // ID duy nh·∫•t cho M·ªåI passage/section
    const MAX_QUESTIONS_PER_TEST = 40; // Gi·ªõi h·∫°n t·ªïng s·ªë c√¢u h·ªèi

    // H√†m x√≥a chung cho passage/question
    function removeThisBlock(buttonElement, blockSelector, updateFn) {
        const blockToRemove = buttonElement.closest(blockSelector);
        if (blockToRemove) {
            blockToRemove.remove();
            if (updateFn) updateFn();
            updateAddButtonState(); // Lu√¥n ki·ªÉm tra n√∫t 40 c√¢u
        } else {
            console.error("Could not find block to remove with selector:", blockSelector);
        }
    }

    // H√†m c·∫≠p nh·∫≠t s·ªë th·ª© t·ª± c√¢u h·ªèi TRONG M·ªñI passage/section
    function updateQuestionNumbers() {
        const allPassageBlocks = document.querySelectorAll('.passage-block');
        allPassageBlocks.forEach((passageBlock) => {
            const questionContainer = passageBlock.querySelector('.questions-container');
            if (questionContainer) {
                const questionsInPassage = questionContainer.querySelectorAll('.question-block');
                questionsInPassage.forEach((block, index) => {
                    const label = block.querySelector('.question-label');
                    if (label) {
                        label.textContent = `C√¢u h·ªèi ${index + 1}`; // S·ªë th·ª© t·ª± trong passage/section n√†y
                    }
                });
            }
        });
    }

    // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c n√∫t "+ C√¢u h·ªèi" d·ª±a tr√™n t·ªïng s·ªë c√¢u h·ªèi
    function updateAddButtonState() {
        const allQuestionBlocks = document.querySelectorAll('.question-block');
        const addQuestionBtns = document.querySelectorAll('.add-question-btn'); // L·∫•y t·∫•t c·∫£ c√°c n√∫t th√™m c√¢u h·ªèi trong t·ª´ng passage/section
        const totalQuestions = allQuestionBlocks.length;

        addQuestionBtns.forEach(btn => {
            const isDisabled = totalQuestions >= MAX_QUESTIONS_PER_TEST;
            btn.disabled = isDisabled;
            btn.textContent = isDisabled ? 'ƒê√£ ƒë·∫°t t·ªëi ƒëa' : '+ C√¢u h·ªèi';
            btn.classList.toggle('bg-gray-400', isDisabled);
            btn.classList.toggle('hover:bg-gray-400', isDisabled);
            btn.classList.toggle('bg-green-500', !isDisabled);
            btn.classList.toggle('hover:bg-green-600', !isDisabled);
        });
    }

    // -------------------------------------------------------------------
    // C√ÅC H√ÄM "CON" (ƒë·ªÉ th√™m l·ª±a ch·ªçn, th√™m c√¢u h·ªèi con)
    // -------------------------------------------------------------------
    let mcOptionCount = 0;
    function addMcOption(buttonElement, passageId, questionId) {
        mcOptionCount++;
        const container = buttonElement.previousElementSibling; // Find '.dynamic-options-container'
        if (!container) return;
        const optionDiv = document.createElement('div');
        optionDiv.className = 'flex items-center space-x-2';
        // Name: passages[passageId][questions][questionId][options][option_...]
        optionDiv.innerHTML = `
            <input type="text" name="passages[${passageId}][questions][${questionId}][options][option_${mcOptionCount}]" class="w-full border rounded px-3 py-2 text-sm" placeholder="N·ªôi dung l·ª±a ch·ªçn (v√≠ d·ª•: A. ...)">
            <button type="button" onclick="this.parentElement.remove()" class="text-red-500 text-sm flex-shrink-0">X√≥a</button>
        `;
        container.appendChild(optionDiv);
    }

    let subQuestionCount = 0;
    function addMatchingSubQuestion(buttonElement, passageId, questionId) {
        subQuestionCount++;
        const container = buttonElement.previousElementSibling; // Find '.sub-questions-container'
        if (!container) return;
        const subQuestionDiv = document.createElement('div');
        subQuestionDiv.className = 'flex items-center space-x-2 bg-gray-50 p-2 rounded';
        // Name: passages[passageId][questions][questionId][sub_questions][sq_...][query/answer]
        subQuestionDiv.innerHTML = `
            <input type="text" name="passages[${passageId}][questions][${questionId}][sub_questions][sq_${subQuestionCount}][query]" class="w-1/3 border rounded px-3 py-2 text-sm" placeholder="C√¢u h·ªèi (v√≠ d·ª•: ƒêo·∫°n A)">
            <input type="text" name="passages[${passageId}][questions][${questionId}][sub_questions][sq_${subQuestionCount}][answer]" class="w-2/3 border rounded px-3 py-2 text-sm" placeholder="ƒê√°p √°n (v√≠ d·ª•: iii)">
            <button type="button" onclick="this.parentElement.remove()" class="text-red-500 text-sm flex-shrink-0">X√≥a</button>
        `;
        container.appendChild(subQuestionDiv);
    }

    // -------------------------------------------------------------------
    // H√ÄM "V·∫º" TEMPLATE CHO C√ÇU H·ªéI
    // -------------------------------------------------------------------
    function createQuestionShell(passageId, questionId, type, typeLabel) {
        // Name uses internal unique questionIdCounter (via questionId param)
        // Display label uses internal ID temporarily, updated by updateQuestionNumbers()
        // onclick uses correct removeThisBlock syntax
        return `
            <input type="hidden" name="passages[${passageId}][questions][${questionId}][type]" value="${type}">
            <div class="flex justify-between items-center">
                <div>
                    <label class="question-label block text-gray-700 font-semibold mb-1">C√¢u h·ªèi ${questionId}</label> <!-- Temp label -->
                    <span class="text-sm text-indigo-600 font-medium">${typeLabel}</span>
                </div>
                <button type="button" onclick="removeThisBlock(this, '.question-block', updateQuestionNumbers)" class="text-red-500 hover:text-red-700 text-sm">X√≥a c√¢u h·ªèi</button>
            </div>
            <label class="block text-gray-700 text-sm">D·∫£i c√¢u h·ªèi (Range):</label>
            <input type="text" name="passages[${passageId}][questions][${questionId}][question_range]" class="w-full border rounded px-3 py-2 text-sm" placeholder="V√≠ d·ª•: 1-5 ho·∫∑c 6" required>
        `;
    }
    function createSimpleQuestionHTML(passageId, questionId, type) {
        let label = "ƒêi·ªÅn v√†o ch·ªó tr·ªëng";
        if (type === 'true_false_not_given') label = "True/False/Not Given";
        if (type === 'yes_no_not_given') label = "Yes/No/Not Given";
        return `
            ${createQuestionShell(passageId, questionId, type, label)}
            <label class="block text-gray-700 text-sm">N·ªôi dung c√¢u h·ªèi/H∆∞·ªõng d·∫´n (Instruction):</label>
            <textarea name="passages[${passageId}][questions][${questionId}][query]" rows="2" class="w-full border rounded px-3 py-2 text-sm" required></textarea>
            <label class="block text-gray-700 text-sm">ƒê√°p √°n ƒë√∫ng (Answer):</label>
            <input type="text" name="passages[${passageId}][questions][${questionId}][answer]" class="w-full border rounded px-3 py-2 text-sm" placeholder="V√≠ d·ª•: water..." required>
        `;
    }
    function createMultipleChoiceHTML(passageId, questionId) {
        return `
            ${createQuestionShell(passageId, questionId, 'multiple_choice', 'Tr·∫Øc nghi·ªám (ƒê·ªông)')}
            <label class="block text-gray-700 text-sm">N·ªôi dung c√¢u h·ªèi/H∆∞·ªõng d·∫´n (Instruction):</label>
            <textarea name="passages[${passageId}][questions][${questionId}][query]" rows="2" class="w-full border rounded px-3 py-2 text-sm" required></textarea>
            <label class="block text-gray-700 text-sm">ƒê√°p √°n ƒë√∫ng (Answer):</label>
            <input type="text" name="passages[${passageId}][questions][${questionId}][answer]" class="w-full border rounded px-3 py-2 text-sm" placeholder="V√≠ d·ª•: A" required>
            <div class="dynamic-options-container space-y-2 pl-4 border-l-2 border-indigo-200">
                <label class="block text-gray-600 text-sm font-medium">C√°c l·ª±a ch·ªçn (Options):</label>
            </div>
            <button type="button" onclick="addMcOption(this, ${passageId}, ${questionId})" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">+ Th√™m l·ª±a ch·ªçn</button>
        `;
    }
    function createMatchingHTML(passageId, questionId) {
        return `
            ${createQuestionShell(passageId, questionId, 'matching', 'Matching (N·ªëi)')}
            <label class="block text-gray-700 text-sm">C√¢u h·ªèi ch√≠nh/H∆∞·ªõng d·∫´n (Instruction):</label>
            <textarea name="passages[${passageId}][questions][${questionId}][query]" rows="3" class="w-full border rounded px-3 py-2 text-sm" required></textarea>
            <label class="block text-gray-600 text-sm font-medium">Danh s√°ch c√°c Items:</label>
            <textarea name="passages[${passageId}][questions][${questionId}][matching_items]" rows="4" class="w-full border rounded px-3 py-2 text-sm" placeholder="M·ªói item 1 d√≤ng..."></textarea>
            <div class="sub-questions-container space-y-3 pt-3 border-t">
                <label class="block text-gray-600 text-sm font-medium">C√°c c√¢u h·ªèi con (Sub-questions):</label>
            </div>
            <button type="button" onclick="addMatchingSubQuestion(this, ${passageId}, ${questionId})" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">+ Th√™m c√¢u h·ªèi con</button>
        `;
    }

    // -------------------------------------------------------------------
    // H√ÄM "V·∫º" TEMPLATE CHO PASSAGE/SECTION
    // -------------------------------------------------------------------
    function createPassageHTML(passageId, isListening) {
        const passageLabelDisplay = isListening ? `Section ${passageId}` : `ƒêo·∫°n vƒÉn (Passage) ${passageId}`; // Label t·∫°m th·ªùi
        const passageTextLabel = isListening ? `Ghi ch√∫ Section (t√πy ch·ªçn)` : `N·ªôi dung ƒëo·∫°n vƒÉn:`;
        const passageTextPlaceholder = isListening ? `V√≠ d·ª•: Ph·∫ßn n√†y n√≥i v·ªÅ ch·ªß ƒë·ªÅ ABC...` : `D√°n n·ªôi dung b√†i ƒë·ªçc v√†o ƒë√¢y...`;
        const removeButtonText = isListening ? 'X√≥a Section' : 'X√≥a Passage';

        // Name uses internal unique passageIdCounter (via passageId param)
        return `
            <div class="passage-block border rounded p-4 bg-white shadow-md space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="passage-label text-lg font-semibold text-purple-700">${passageLabelDisplay}</h3> <!-- Temp label -->
                    <button type="button" onclick="removeThisBlock(this, '.passage-block', updatePassageNumbers)" class="text-red-500 hover:text-red-700 text-sm">${removeButtonText}</button>
                </div>
                <div class="${isListening ? 'hidden' : ''}">
                    <label class="block text-gray-700 mb-1 text-sm">${passageTextLabel}</label>
                    <textarea name="passages[${passageId}][text]" rows="6" class="w-full border rounded px-3 py-2 focus:ring focus:ring-indigo-200 text-sm" placeholder="${passageTextPlaceholder}"></textarea>
                </div>
                <div class="questions-container border-t pt-4 space-y-6">
                     <h4 class="text-md font-semibold text-gray-600">C√¢u h·ªèi cho <span class="dynamic-passage-label">${passageLabelDisplay}</span></h4> <!-- Dynamic label -->
                </div>
                 <div class="mt-4 flex items-center space-x-3 p-2 bg-gray-100 rounded">
                     <label for="question-type-select-${passageId}" class="text-sm font-medium">Th√™m c√¢u h·ªèi lo·∫°i:</label>
                     <select id="question-type-select-${passageId}" class="border rounded px-2 py-1 text-sm">
                         <option value="fill_in_blank">ƒêi·ªÅn tr·ªëng</option>
                         <option value="multiple_choice">Tr·∫Øc nghi·ªám</option>
                         <option value="true_false_not_given">T/F/NG</option>
                         <option value="yes_no_not_given">Y/N/NG</option>
                         <option value="matching">Matching</option>
                     </select>
                     <button type="button" onclick="addQuestionToPassage(${passageId})"
                        class="add-question-btn bg-green-500 text-white font-medium px-3 py-1 rounded text-sm hover:bg-green-600 transition">
                        + C√¢u h·ªèi
                     </button>
                 </div>
            </div>`;
    }

    // -------------------------------------------------------------------
    // H√ÄM C·∫¨P NH·∫¨T S·ªê TH·ª® T·ª∞ PASSAGE/SECTION V√Ä C√ÅC LABEL LI√äN QUAN
    // -------------------------------------------------------------------
    function updatePassageNumbers() {
        const container = document.getElementById('passages-container');
        if (!container) return;
        const allPassageBlocks = container.querySelectorAll('.passage-block');
        const isListening = document.getElementById('category-select').value === 'Listening';

        allPassageBlocks.forEach((block, index) => {
            const displayIndex = index + 1;
            const label = block.querySelector('.passage-label');
            const dynamicLabelSpan = block.querySelector('.dynamic-passage-label'); // Label trong v√πng c√¢u h·ªèi
            const removeButton = block.querySelector('button[onclick*="removeThisBlock"]'); // N√∫t x√≥a

            const passageLabelText = isListening ? `Section ${displayIndex}` : `ƒêo·∫°n vƒÉn (Passage) ${displayIndex}`;

            if (label) label.textContent = passageLabelText;
            if (dynamicLabelSpan) dynamicLabelSpan.textContent = passageLabelText;
            if (removeButton) removeButton.textContent = isListening ? 'X√≥a Section' : 'X√≥a Passage';

        });
        // C·∫≠p nh·∫≠t text n√∫t th√™m v√† legend
        const addBtnText = document.getElementById('add-passage-section-text');
        if (addBtnText) addBtnText.textContent = isListening ? 'Section' : 'ƒêo·∫°n vƒÉn';
        const legendText = document.getElementById('passage-section-legend');
        if (legendText) legendText.textContent = isListening ? '2. C√°c Section' : '2. C√°c ƒêo·∫°n vƒÉn (Passages)';
    }

    // -------------------------------------------------------------------
    // H√ÄM TH√äM C√ÇU H·ªéI V√ÄO PASSAGE/SECTION
    // -------------------------------------------------------------------
    function addQuestionToPassage(passageId) {
        // T√¨m passage block d·ª±a tr√™n ID duy nh·∫•t ƒë√£ g√°n khi t·∫°o
        const passageBlock = document.querySelector(`.passage-block[data-passage-id="${passageId}"]`);
        if (!passageBlock) {
            console.error(`Could not find passage block with data-passage-id=${passageId}`);
            return;
        }

        const questionContainer = passageBlock.querySelector('.questions-container');
        const typeSelect = passageBlock.querySelector(`#question-type-select-${passageId}`);
        if (!questionContainer || !typeSelect) return;

        if (document.querySelectorAll('.question-block').length >= MAX_QUESTIONS_PER_TEST) {
            alert(`ƒê√£ ƒë·∫°t t·ªëi ƒëa ${MAX_QUESTIONS_PER_TEST} c√¢u h·ªèi cho to√†n b·ªô b√†i test.`);
            return;
        }

        questionIdCounter++; // ID c√¢u h·ªèi to√†n c·ª•c lu√¥n tƒÉng
        const selectedType = typeSelect.value;

        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-block border rounded p-3 bg-gray-50 space-y-2 shadow-sm';
        let questionHTML = '';

        switch (selectedType) {
            case 'fill_in_blank':
            case 'true_false_not_given':
            case 'yes_no_not_given':
                questionHTML = createSimpleQuestionHTML(passageId, questionIdCounter, selectedType);
                break;
            case 'multiple_choice':
                questionHTML = createMultipleChoiceHTML(passageId, questionIdCounter);
                break;
            case 'matching':
                questionHTML = createMatchingHTML(passageId, questionIdCounter);
                break;
        }

        questionDiv.innerHTML = questionHTML;
        questionContainer.appendChild(questionDiv);
        updateQuestionNumbers(); // C·∫≠p nh·∫≠t s·ªë th·ª© t·ª± c√¢u h·ªèi trong passage n√†y
        updateAddButtonState();
    }


    // -------------------------------------------------------------------
    // H√ÄM CH√çNH (Main execution)
    // -------------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', function () {
        const categorySelect = document.getElementById('category-select');
        const audioUploadField = document.getElementById('audio-upload-field');
        const addPassageBtn = document.getElementById('add-passage-btn');
        const passagesContainer = document.getElementById('passages-container');

        // --- Logic ·∫©n/hi·ªán tr∆∞·ªùng Upload v√† thay ƒë·ªïi text ---
        function toggleFieldsAndLabels() {
            if (!categorySelect || !audioUploadField || !passagesContainer) return; // Guard clause

            const isListening = categorySelect.value === 'Listening';
            audioUploadField.classList.toggle('hidden', !isListening);

            // X√≥a h·∫øt passage/section c≈© khi ƒë·ªïi category
            passagesContainer.innerHTML = '';
            passageIdCounter = 0; // Reset ID passage
            questionIdCounter = 0; // Reset ID question ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i t·ª´ 1 cho category m·ªõi
            updatePassageNumbers();
            updateAddButtonState();
        }

        if (categorySelect) {
            toggleFieldsAndLabels();
            categorySelect.addEventListener('change', toggleFieldsAndLabels);
        } else {
            console.error("Category select element not found!");
        }

        // --- Logic th√™m Passage/Section ---
        if (addPassageBtn && passagesContainer) {
            addPassageBtn.addEventListener('click', function () {
                passageIdCounter++; // ID passage/section lu√¥n tƒÉng
                const isListening = categorySelect.value === 'Listening';
                const passageHTML = createPassageHTML(passageIdCounter, isListening);
                const tempDiv = document.createElement('div'); // T·∫°o div t·∫°m ƒë·ªÉ ch·ª©a HTML
                tempDiv.innerHTML = passageHTML.trim(); // Parse HTML string
                const passageElement = tempDiv.firstChild; // L·∫•y element .passage-block

                // G√°n ID duy nh·∫•t v√†o data attribute ƒë·ªÉ h√†m addQuestionToPassage t√¨m th·∫•y
                if (passageElement && passageElement.classList.contains('passage-block')) {
                    passageElement.setAttribute('data-passage-id', passageIdCounter);
                    passagesContainer.appendChild(passageElement);
                    updatePassageNumbers();
                } else {
                    console.error("Failed to create passage element from HTML");
                }
            });
        } else {
            if (!addPassageBtn) console.error("Add passage button not found!");
            if (!passagesContainer) console.error("Passages container not found!");
        }

        // G·ªçi h√†m ki·ªÉm tra n√∫t 40 c√¢u khi t·∫£i trang
        updateAddButtonState();

    }); // <-- D·∫§U ƒê√ìNG C·ª¶A DOMContentLoaded
</script>
{% endblock %}