{% extends 'base.html' %}

{% block title %}
B·∫£ng ƒëi·ªÅu khi·ªÉn
{% endblock %}

{% block content %}
<!-- (M·ªöI) T·∫£i th∆∞ vi·ªán Chart.js ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="flex flex-col md:flex-row h-screen bg-gray-100 font-sans">

    <!-- ===== C·ªòT B√äN TR√ÅI (SIDEBAR) ===== -->
    <aside class="w-full md:w-64 bg-gray-800 text-white p-6 space-y-6 flex-shrink-0">
        <h1 class="text-2xl font-bold mb-6">B·∫£ng ƒëi·ªÅu khi·ªÉn</h1>

        <nav class="space-y-3">
            <!-- Link L·ªãch s·ª≠ -->
            <a href="{{ url_for('dashboard.user_dashboard', section='history') }}" class="block py-2 px-3 rounded transition
                      {% if section == 'history' %} bg-blue-600 text-white {% else %} hover:bg-gray-700 {% endif %}">
                üìö L·ªãch s·ª≠ l√†m b√†i
            </a>

            <!-- Link Th·ªëng k√™ -->
            <a href="{{ url_for('dashboard.user_dashboard', section='statistics') }}"
                class="block py-2 px-3 rounded transition
                      {% if section == 'statistics' %} bg-blue-600 text-white {% else %} hover:bg-gray-700 {% endif %}">
                üìä Th·ªëng k√™ chung
            </a>
            <a href="{{ url_for('dashboard.user_dashboard', section='profile') }}" class="block py-2 px-3 rounded transition
                                    {% if section == 'profile' %} bg-blue-600 text-white {% else %} hover:bg-gray-700 {% endif %}">
                üë§ Th√¥ng tin c√° nh√¢n
            </a>
            <!-- Link Quay l·∫°i trang ch·ªß -->
            <a href="{{ url_for('index') }}" class="block py-2 px-3 rounded hover:bg-gray-700 transition">
                üè† V·ªÅ trang ch·ªß
            </a>

            <!-- Link ƒêƒÉng xu·∫•t -->
            <a href="{{ url_for('auth.logout') }}"
                class="block py-2 px-3 rounded hover:bg-gray-700 transition text-red-400">
                üö™ ƒêƒÉng xu·∫•t
            </a>
        </nav>
    </aside>

    <!-- ===== C·ªòT B√äN PH·∫¢I (MAIN CONTENT) ===== -->
    <main class="flex-1 p-8 overflow-y-auto">

        <!-- ===== HI·ªÇN TH·ªä PH·∫¶N L·ªäCH S·ª¨ L√ÄM B√ÄI ===== -->
        {% if section == 'history' %}
        <section id="history">
            <h2 class="text-3xl font-semibold mb-6 text-gray-800">üìö L·ªãch s·ª≠ l√†m b√†i</h2>
            {% if all_results %}
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-gray-100 border-b">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ng√†y l√†m</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">T√™n ƒë·ªÅ thi</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lo·∫°i</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">ƒêi·ªÉm s·ªë</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Xem l·∫°i</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in all_results %}
                        <tr class="hover:bg-gray-50 border-b">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                {{ result.taken_at.strftime('%d-%m-%Y %H:%M') }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {{ result.test.title }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                {% if result.test.category == 'Reading' %}
                                <span
                                    class="px-2 py-1 text-xs font-semibold text-blue-800 bg-blue-100 rounded-full">Reading</span>
                                {% else %}
                                <span
                                    class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full">Listening</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-gray-800">
                                {{ result.score|int }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                                <a href="{{ url_for('test.show_test_result', result_id=result.id) }}"
                                    class="text-blue-600 hover:text-blue-800 hover:underline">
                                    Xem chi ti·∫øt
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                <p class="text-gray-600 italic">B·∫°n ch∆∞a ho√†n th√†nh b√†i test n√†o.</p>
            </div>
            {% endif %}
        </section>
        {% endif %}
{% if section == 'profile' %}
<section id="profile">
    <h2 class="text-3xl font-semibold mb-6 text-gray-800">üë§ Th√¥ng tin c√° nh√¢n</h2>

    <!-- Kh·ªëi flash message (n·∫øu c√≥) -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-4 space-y-2">
        {% for category, message in messages %}
        {% set alert_class = 'bg-red-100 border-red-400 text-red-700' if category == 'error' else
        ('bg-green-100 border-green-400 text-green-700' if category == 'success' else
        'bg-blue-100 border-blue-400 text-blue-700') %}
        <div class="{{ alert_class }} border px-4 py-3 rounded relative" role="alert">
            <span class="block sm:inline">{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Form c·∫≠p nh·∫≠t -->
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-lg">
        <form method="POST" action="{{ url_for('dashboard.profile_update') }}" class="space-y-4">

            <!-- Th√¥ng tin c√° nh√¢n -->
            <fieldset class="border rounded p-4">
                <legend class="text-lg font-semibold text-gray-700 px-2">Th√¥ng tin t√†i kho·∫£n</legend>
                <div class="space-y-4 mt-2">
                    <div>
                        <label class="block text-gray-700 mb-2">Email (Kh√¥ng th·ªÉ thay ƒë·ªïi):</label>
                        <input type="email" value="{{ user.email }}"
                            class="w-full border rounded px-3 py-2 bg-gray-100 text-gray-500 cursor-not-allowed"
                            disabled>
                    </div>
                    <div>
                        <label for="name" class="block text-gray-700 mb-2">T√™n hi·ªÉn th·ªã:</label>
                        <input type="text" id="name" name="name" value="{{ user.name }}"
                            class="w-full border rounded px-3 py-2 focus:ring focus:ring-blue-200" required>
                    </div>
                </div>
            </fieldset>

        

            <!-- N√∫t Submit -->
            <div class="text-right">
                <button type="submit"
                    class="bg-blue-600 text-white font-medium px-6 py-2 rounded hover:bg-blue-700 transition">
                    L∆∞u thay ƒë·ªïi
                </button>
            </div>
        </form>
    </div>
</section>
{% endif %}
        <!-- ===== HI·ªÇN TH·ªä PH·∫¶N TH·ªêNG K√ä CHUNG ===== -->
        {% if section == 'statistics' %}
        <section id="statistics">
            <h2 class="text-3xl font-semibold mb-6 text-gray-800">üìä Th·ªëng k√™ chung</h2>

            <!-- Grid 2 c·ªôt cho bi·ªÉu ƒë·ªì -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Bi·ªÉu ƒë·ªì Reading -->
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-center"> Reading </h3>
                    <canvas id="readingChart"></canvas>
                </div>
                <!-- Bi·ªÉu ƒë·ªì Listening -->
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-center"> Listening </h3>
                    <canvas id="listeningChart"></canvas>
                </div>
            </div>

            <!-- Grid 2 c·ªôt cho L·ªãch v√† Th·ªëng k√™ c√¢u sai -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- L·ªãch ho·∫°t ƒë·ªông -->
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">
                        L·ªãch s·ª≠ luy·ªán t·∫≠p ({{ calendar_data.month_name }} {{ calendar_data.year }})
                    </h3>
                    <div class="grid grid-cols-7 gap-1 text-center">
                        {% for day_name in ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
                        <div class="font-medium text-xs text-gray-500">{{ day_name }}</div>
                        {% endfor %}

                        {% for week in calendar_data.weeks %}
                        {% for day in week %}
                        {% if day %}
                        <div
                            class="w-full h-10 flex items-center justify-center rounded
                                   {% if day.is_today %} border-2 border-blue-500 {% else %} border border-gray-200 {% endif %}
                                   {% if day.has_submission %} bg-green-500 text-white font-bold {% else %} bg-gray-50 text-gray-700 {% endif %}">
                            {{ day.day }}
                        </div>
                        {% else %}
                        <div></div>
                        {% endif %}
                        {% endfor %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Th·ªëng k√™ c√¢u sai theo lo·∫°i -->
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">Ph√¢n t√≠ch l·ªói sai (Theo lo·∫°i c√¢u h·ªèi)</h3>
                    <div class="space-y-4">
                        {% if stats_data.question_type_stats %}
                        {% for stat in stats_data.question_type_stats %}
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">{{ stat.type_name }}</span>
                                <span class="text-sm font-medium text-red-600">
                                    {{ stat.wrong_percent }}% Sai ({{ stat.wrong_count }}/{{ stat.total }})
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-red-500 h-2.5 rounded-full" style="width: {{ stat.wrong_percent }}%">
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-gray-600 italic">Ch∆∞a c√≥ d·ªØ li·ªáu c√¢u sai ƒë·ªÉ ph√¢n t√≠ch.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

        </section>
        {% endif %}

    </main>
</div>

<!-- ===== JAVASCRIPT V·∫º BI·ªÇU ƒê·ªí ===== -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        if (document.getElementById('statistics')) {

            function createChart(ctx, labels, scores, color) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ƒêi·ªÉm s·ªë',
                            data: scores,
                            borderColor: color,
                            backgroundColor: color + '33',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 40
                            }
                        },
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }

            // --- Reading ---
            const readingCtx = document.getElementById('readingChart');
            if (readingCtx) {
                const readingLabels = {{ stats_data.last_5_reading_labels | default ('[]') | safe
                }};
        const readingScores = {{ stats_data.last_5_reading_scores | default ('[]') | safe
    }};
    createChart(readingCtx, readingLabels, readingScores, '#2563eb');
        }

    // --- Listening ---
    const listeningCtx = document.getElementById('listeningChart');
    if (listeningCtx) {
        const listeningLabels = {{ stats_data.last_5_listening_labels | default ('[]') | safe }};
    const listeningScores = {{ stats_data.last_5_listening_scores | default ('[]') | safe }};
    createChart(listeningCtx, listeningLabels, listeningScores, '#16a34a');
        }
    }
});
</script>
{% endblock %}